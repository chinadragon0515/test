<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>4.3 RESTier API Service (>=0.5.0)</title>
  <meta name="description" content="Users can inject their custom API services into RESTier to extend various functionalities. There is a big progress since 0.4.0. Now the concept of hook handl...">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
  <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  
  <link rel="stylesheet" href="/RESTier/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/RESTier/04-03-Api-Service/">
  <link rel="alternate" type="application/rss+xml" title="RESTier" href="http://yourdomain.com/RESTier/feed.xml" />
</head>


  <body data-spy="scroll" data-target="#nav-sidebar">

    <header class="site-header">

  <div class="container">

    <a class="site-title" href="/RESTier/">RESTier</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="container">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">4.3 RESTier API Service (>=0.5.0)</h1>
    <p class="post-meta">Mar 18, 2016</p>
  </header>

  <article class="post-content">
    <p>Users can inject their custom API services into RESTier to extend various functionalities. There is a big progress since 0.4.0. Now the concept of <strong>hook handler</strong> has become <strong>API service</strong> in 0.5.0. We have removed the old interfaces <code class="highlighter-rouge">IHookHandler</code> and <code class="highlighter-rouge">IDelegateHookHandler</code> to adapt to the concept change. Thus the implementation of any custom API service (previously known as hook handler) should also be changed accordingly.</p>

<p>All API services registered as <strong>one specific type</strong> (either a class or an interface) are organized in a consistently chained (or nested) way. Each API service in a chain can choose whether to call the next (or inner) API service. The last API service registered is always invoked first if current service always call inner method first.</p>

<p>As a practical example in RESTier, there is an API service interface called <code class="highlighter-rouge">IModelBuilder</code> to build or extend an EDM model. By default, RESTier will register two model builders for <code class="highlighter-rouge">IModelBuilder</code>. The model builder from the data provider (e.g., <code class="highlighter-rouge">ModelProducer</code> in RESTier EF) is always registered first. The <code class="highlighter-rouge">RestierModelExtender</code> is always registered later. Any custom model builder will be registered sequentially between or before or after the two built-in model builders based on the way been registered. When the API service <code class="highlighter-rouge">IModelBuilder</code> is invoked, the outermost <code class="highlighter-rouge">ModelBuilder</code> is always invoked first. It first invokes the inner API service which could possibly be the model builder from the data provider or some custom model builder (if any). The custom model builder can choose to extend the model returned from an inner builder, or otherwise it can simply choose not to call the inner one and directly return a new model. The model builder from the data provider is typically innermost and thus has no inner builder to call.</p>

<p>This subsection shows how to implement custom API services and inject them into RESTier between two built-in model builders. For before or after, refer to <a href="http://odata.github.io/RESTier/#02-05-Model-building-0-5-0">section 2.5 Model Building</a> part. This is common for all other services which allows customization.</p>

<h3 id="implement-an-api-service">Implement an API service</h3>
<p>The following sample code is to implement a custom model builder. Please note that if you want to call the inner builder, you need to put a <strong>settable property</strong> of <code class="highlighter-rouge">IModelBuilder</code> into your builder class. <strong>The accessibility and the name of the property doesn’t matter here</strong>. Then try to call the inner builder in the service implementation. If you don’t want to call any inner builder, you can just <strong>omit the property</strong> and remove the related logic.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyModelBuilder</span> <span class="p">:</span> <span class="n">IModelBuilder</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IModelBuilder</span> <span class="n">InnerBuilder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEdmModel</span><span class="p">&gt;</span> <span class="nf">GetModelAsync</span><span class="p">(</span><span class="n">InvocationContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">IEdmModel</span> <span class="n">model</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">InnerBuilder</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Call the inner builder to build a model first.
</span>            <span class="n">model</span> <span class="p">=</span> <span class="n">await</span> <span class="k">this</span><span class="p">.</span><span class="n">InnerBuilder</span><span class="p">.</span><span class="nf">GetModelAsync</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Do something to extend the model.
</span>        <span class="p">}</span>

        <span class="k">return</span> <span class="n">model</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="register-an-api-service">Register an API service</h3>
<p>We need to register <code class="highlighter-rouge">MyModelBuilder</code> into the API to make it work. You can override the <code class="highlighter-rouge">ConfigureApi</code> method in your API class to do so. Here is the sample code. If you want to call the inner builder, you need to register it using <code class="highlighter-rouge">ChainPrevious</code> otherwise use <code class="highlighter-rouge">CutoffPrevious</code> instead. There are also overloads for the two methods that take an existing service instance or a service factory method. By the way, all those methods are fluent API so you can call them in a chained way.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyApi</span> <span class="p">:</span> <span class="n">ApiBase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">IServiceCollection</span> <span class="nf">ConfigureApi</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>        
            <span class="n">Type</span> <span class="n">apiType</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="nf">GetType</span><span class="p">();</span>
            <span class="c1">// Add core and conversion's services
</span>            <span class="n">services</span> <span class="p">=</span> <span class="n">services</span><span class="p">.</span><span class="nf">AddCoreServices</span><span class="p">(</span><span class="n">apiType</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">AddAttributeServices</span><span class="p">(</span><span class="n">apiType</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">AddConventionBasedServices</span><span class="p">(</span><span class="n">apiType</span><span class="p">);</span>

            <span class="c1">// Add EF related services which has ModelProducer
</span>            <span class="n">services</span><span class="p">.</span><span class="n">AddEfProviderServices</span><span class="p">&lt;</span><span class="n">NorthwindContext</span><span class="p">&gt;();</span>

            <span class="c1">// Add customized services, after EF model builder and before WebApi operation model builder
</span>            <span class="n">services</span><span class="p">.</span><span class="n">ChainPrevious</span><span class="p">&lt;</span><span class="n">IModelBuilder</span><span class="p">,</span> <span class="n">MyModelBuilder</span><span class="p">&gt;();</span>

            <span class="c1">// This is used to add the publisher's services which has RestierModelExtender
</span>            <span class="n">ApiConfiguration</span><span class="p">.</span><span class="nf">GetPublisherServiceCallback</span><span class="p">(</span><span class="n">apiType</span><span class="p">)(</span><span class="n">services</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>If you want to register a lambda expression (usually for advanced usage) as an API service, you can use the <code class="highlighter-rouge">AddContributor&lt;T&gt;</code> method. Here is an example. The parameter <code class="highlighter-rouge">sp</code> is of <code class="highlighter-rouge">IServiceProvider</code> and the parameter <code class="highlighter-rouge">next</code> is of <code class="highlighter-rouge">Func&lt;T&gt;</code> which represents the factory of the last API service registered. This means you can call <code class="highlighter-rouge">next()</code> to get the last API service instance.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">services</span><span class="p">.</span><span class="n">AddContributor</span><span class="p">&lt;</span><span class="n">IModelBuilder</span><span class="p">&gt;((</span><span class="n">sp</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="cm">/* return a model builder */</span><span class="p">);</span></code></pre></figure>

<p>In the service implementation, the parameter type <code class="highlighter-rouge">IServiceCollection</code> is actually a container builder from Microsoft Dependency Injection Framework (DI). You can do whatever applicable to a normal DI container here. It is notable that you can also take advantage of the powerful <strong>scope</strong> feature in DI here! RESTier will create a new scope for each individual request in <code class="highlighter-rouge">ApiContext</code> which enables you to register scoped services whose lifetime is per-request.</p>

<p>Please visit <a href="https://docs.asp.net/en/latest/fundamentals/dependency-injection.html">https://docs.asp.net/en/latest/fundamentals/dependency-injection.html</a> to grasp some basic understanding about DI before proceeding.</p>

<p>The following example is to register a scoped <code class="highlighter-rouge">MyDbContext</code> service so that you have a new <code class="highlighter-rouge">MyDbContext</code> instance for each request.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyDbContext</span> <span class="p">:</span> <span class="n">DbContext</span> <span class="p">{...}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MyApi</span> <span class="p">:</span> <span class="n">ApiBase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">IServiceCollection</span> <span class="nf">ConfigureApi</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">ConfigureApi</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
            <span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="n">sp</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;());</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You can also make a specific API service singleton, scoped or transient (though not common) by calling <code class="highlighter-rouge">MakeSingleton</code>, <code class="highlighter-rouge">MakeScoped</code> or <code class="highlighter-rouge">MakeTransient</code>. Here is a sample which is to make <code class="highlighter-rouge">IModelBuilder</code> scoped.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyApi</span> <span class="p">:</span> <span class="n">ApiBase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="n">IServiceCollection</span> <span class="nf">ConfigureApi</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Previous registered logic
</span>        <span class="p">...</span>
        <span class="n">services</span><span class="p">.</span><span class="n">MakeScoped</span><span class="p">&lt;</span><span class="n">IModelBuilder</span><span class="p">&gt;();</span>
        <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="get-an-api-service">Get an API service</h3>
<p>No matter in which way you register an API service of <code class="highlighter-rouge">T</code>, the only and unified way to get that service out is to use <code class="highlighter-rouge">(ApiContext).GetApiService&lt;T&gt;</code> from RESTier or <code class="highlighter-rouge">IServiceProvider.GetService&lt;T&gt;</code> from DI.</p>

  </article>

     <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'odatanetlibrariessamples'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="container">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55977038-3', 'auto');
    ga('send', 'pageview');
  </script>
  
    <h2 class="footer-heading">RESTier</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>RESTier</li>
          <li><a href="mailto:odatafeedback@microsoft.com">odatafeedback@microsoft.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/odata">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">odata</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Documentation - tutorials, guides - for RESTier.
  The materials available on this site are licensed as set forth <a href="https://github.com/OData/odata.github.io/blob/master/License.txt">here</a>.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
